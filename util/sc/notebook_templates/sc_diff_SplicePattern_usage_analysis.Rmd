---
title: "sc_diff_SplicePattern_usage_analysis"
output: html_document
date: "2025-06-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(Seurat)
library(pheatmap)

```


# define inputs

```{r}

source("iso_plot_funcs.R")


sample_name = "PBMCs_LRAA-splicepatterns"

sparse_matrix_data_dir = "../pbmcs_refGuided/pbmcs_refGuided_sc_cluster_guided/scg_splice_collapsed/PBMCs_pbio.LRAA.sc^splice_pattern-sparseM/"

umap_cluster_file = "../pbmcs_refGuided/data/PBMCs_pbio.genes-cell_cluster_assignments.wUMAP.tsv"

cluster_pseudobulk_matrix_filename = "../pbmcs_refGuided/pbmcs_refGuided_sc_cluster_guided/scg_splice_collapsed/PBMCs_pbio.LRAA.sc^splice_pattern-sparseM.resources/PBMCs_pbio.LRAA.sc^splice_pattern-sparseM.cluster_pseudobulk.matrix"

gtf_filename = "../pbmcs_refGuided/pbmcs_refGuided_sc_cluster_guided/scg_splice_collapsed/LRAA.pbmcs.sc-cluster-guided.refGuided.sp_collapsed.segmented.gtf"

diff_iso_usage_stats_filename = "../pbmcs_refGuided/pbmcs_refGuided_sc_cluster_guided/scg_splice_collapsed/PBMCs_pbio.LRAA.sc^splice_pattern.top_only_w_recip_delta_pi.minCF0.05.diff_iso.tsv"


```



# parse inputs

```{r}


parse_inputs(sample_name,
             sparse_matrix_data_dir,
             umap_cluster_file,
             cluster_pseudobulk_matrix_filename,
             gtf_filename,
             diff_iso_usage_stats_filename)

```



```{r}

# pick an example gene to explore

diff_iso_usage_stats = diff_iso_usage_stats %>% arrange(pvalue, desc(abs(delta_pi)))

diff_iso_usage_stats %>% head()
```



```{r}

my_gene_of_interest = diff_iso_usage_stats$gene_id[1]


get_expression_ggplot2_heatmap_w_exon_structures(my_gene_of_interest)


````




```{r}

gene_exon_heatmap_plot = get_expression_ggplot2_heatmap_w_exon_structures(my_gene_of_interest, 
                                                                0.4, ignore_unspliced=T)

p_exon_expr = gene_exon_heatmap_plot$plot

p_exon_expr
```


```{r}

p_umap = plot_isoform_umap(my_gene_of_interest, gene_exon_heatmap_plot$transcript_ids)

p_umap

```



```{r}


p_my_gene_of_interest = make_diff_iso_usage_compound_plot(my_gene_of_interest, 0.4, T)

ggsave(p_my_gene_of_interest, 
       file=paste0(my_gene_of_interest, ".pdf"),
       width=12, 
       height=12
       )

p_my_gene_of_interest

```



# Examine  DTU results w/ same vs different splice code (alt termini vs alt splicing)

```{r}

DTU_results_w_splicehash = diff_iso_usage_stats

DTU_results_w_splicehash %>% head()


```

```{r}

DTU_results_w_splicehash = DTU_results_w_splicehash %>% mutate(same_splice_pattern = (dominant_splice_hashcodes == alternate_splice_hashcodes)) %>% arrange(pvalue, desc(abs(delta_pi)))

DTU_results_w_splicehash 

```

```{r}

# counts of examples according to the different genes and clusters.
DTU_results_w_splicehash %>% group_by(same_splice_pattern) %>% tally()

```

```{r}

# counts according to unique genes and splice pattern agreement or not.

DTU_results_w_splicehash %>% select(gene_id, same_splice_pattern) %>% unique() %>%
  group_by(gene_id) %>%
    mutate(same_splice_patterns_types = paste0(collapse=',', same_splice_pattern)) %>% ungroup() %>%
  select(gene_id, same_splice_patterns_types) %>% unique() %>%
  group_by(same_splice_patterns_types) %>% tally()

```




## top with different splicing pattern

```{r}

top_DTU_results_w_diff_splicehash = DTU_results_w_splicehash %>% filter(! same_splice_pattern) %>% 
  #filter(abs(delta_pi) >= 0.2 & abs(alternate_delta_pi) >= 0.2) %>% 
  #filter(dominant_pi_A >= 0.5 & alternate_pi_B >= 0.5) %>%
  arrange(pvalue)

top_DTU_results_w_diff_splicehash

```



```{r}

transcript_ids_use = c(top_DTU_results_w_diff_splicehash$dominant_transcript_ids[1],
                       top_DTU_results_w_diff_splicehash$alternate_transcript_ids[1])


p = make_diff_iso_usage_compound_plot(top_DTU_results_w_diff_splicehash$gene_id[1], MIN_DELTA_PI, ignore_unspliced = FALSE,
                                      transcript_ids=transcript_ids_use)

plot(p)

```


```{r}

if (TRUE) { # only run on demand
  
  top_DTU_results_w_diff_splicehash_genes = top_DTU_results_w_diff_splicehash %>% 
    group_by(gene_id) %>% arrange(pvalue) %>% filter(row_number() == 1) %>% ungroup() %>% arrange(pvalue) %>%
    head(100)
  
  # Specify the path for the directory you want to create
  top_diff_iso_usage_plots_dir <- paste0("top_", num_top_diff_iso_usage_plots, "_diff_iso_usage-alt-splicing_plots.TOP_ISO_RECIP")
  
  # Check if the directory already exists
  if (!dir.exists(top_diff_iso_usage_plots_dir)) {
    # If the directory doesn't exist, create it
    dir.create(top_diff_iso_usage_plots_dir)
  }
  
  counter = 0
  for(gene_id_val in top_DTU_results_w_diff_splicehash_genes$gene_id) {
    
    message("plotting ", counter, " gene: ", gene_id_val)
    
    filename = paste0(top_diff_iso_usage_plots_dir, "/", counter, ".", gene_id_val, ".diff_iso_usage-alt-splicing.pdf")
    
    counter = counter + 1
    
    print(counter)
    
    #if (counter < 200) {
    #   next;
    #}
    
    #gene_sym_value = paste0("^", gene_sym_value, "\\^")
    
     transcript_ids_use = top_DTU_results_w_diff_splicehash %>% filter(gene_id == gene_id_val) %>%
      select(dominant_transcript_ids, alternate_transcript_ids) %>%
      gather(key=transcript_id_type, value=transcript_id_val, dominant_transcript_ids, alternate_transcript_ids) %>%
      select(transcript_id_val) %>% unique() %>% pull(transcript_id_val)
    
    
    
    tryCatch({
      
      p = make_diff_iso_usage_compound_plot(gene_id_val, MIN_DELTA_PI, ignore_unspliced = F,
                                            transcript_ids=transcript_ids_use)
      ggsave(p, file=filename, width=12, 
             height=12)
      
      
    }, error = function(e) {
      message("Caught error: ", e$message)
      
    })
  }  
}



```



## top with same splicing pattern

```{r}

top_DTU_results_w_same_splicehash = DTU_results_w_splicehash %>% filter(same_splice_pattern) %>% 
  #filter(abs(delta_pi) >= 0.2 & abs(alternate_delta_pi) >= 0.2) %>% 
  #filter(dominant_pi_A >= 0.5 & alternate_pi_B >= 0.5) %>%
  arrange(pvalue, desc(abs(delta_pi)))

top_DTU_results_w_same_splicehash

```

```{r}
transcript_ids_use = c(top_DTU_results_w_same_splicehash$dominant_transcript_ids[1],
                       top_DTU_results_w_same_splicehash$alternate_transcript_ids[1])


p = make_diff_iso_usage_compound_plot(top_DTU_results_w_same_splicehash$gene_id[1], MIN_DELTA_PI, 
                                      ignore_unspliced = FALSE,
                                      transcript_ids=transcript_ids_use)

plot(p)

```


```{r}

if (TRUE) { # only run on demand
  
  top_DTU_results_w_same_splicehash_genes = top_DTU_results_w_same_splicehash %>% 
    group_by(gene_id) %>% arrange(pvalue) %>% filter(row_number() == 1) %>% ungroup() %>% arrange(pvalue) %>%
    head(100)
  
  # Specify the path for the directory you want to create
  top_diff_iso_usage_plots_dir <- paste0("top_", num_top_diff_iso_usage_plots, "_diff_iso_usage-alt-termini-only_plots.TOP_ISO_RECIP")
  
  # Check if the directory already exists
  if (!dir.exists(top_diff_iso_usage_plots_dir)) {
    # If the directory doesn't exist, create it
    dir.create(top_diff_iso_usage_plots_dir)
  }
  
  counter = 0
  for(gene_id_val in top_DTU_results_w_same_splicehash_genes$gene_id) {
    
    message("plotting ", counter, " gene: ", gene_id_val)
    
    filename = paste0(top_diff_iso_usage_plots_dir, "/", counter, ".", gene_id_val, ".diff_iso_usage-alt-termini.pdf")
    
    counter = counter + 1
    
    print(counter)
    
    #if (counter < 200) {
    #   next;
    #}
    
    #gene_sym_value = paste0("^", gene_sym_value, "\\^")
    
    
    transcript_ids_use = top_DTU_results_w_same_splicehash %>% filter(gene_id == gene_id_val) %>%
      select(dominant_transcript_ids, alternate_transcript_ids) %>%
      gather(key=transcript_id_type, value=transcript_id_val, dominant_transcript_ids, alternate_transcript_ids) %>%
      select(transcript_id_val) %>% unique() %>% pull(transcript_id_val)
    
    tryCatch({
      
      p = make_diff_iso_usage_compound_plot(gene_id_val, MIN_DELTA_PI, ignore_unspliced = F, transcript_ids=transcript_ids_use)
      ggsave(p, file=filename, width=12, 
             height=12)
      
      
    }, error = function(e) {
      message("Caught error: ", e$message)
      
    })
  }  
}


```




