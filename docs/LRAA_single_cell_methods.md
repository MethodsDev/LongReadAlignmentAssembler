# LRAA Single-Cell RNA-seq Automated Workflow

LRAA-singlecell is implemented as a Workflow Description Language (WDL) workflow, enabling portable execution across cloud platforms, high-performance computing clusters, and local compute environments.

Unless otherwise noted, all isoform discovery and quantification steps apply the LRAA algorithms described above, with parameters adapted for single-cell data characteristics as specified below.


## Input and Preprocessing

LRAA-singlecell requires coordinate-sorted, indexed BAM files of long-read single-cell RNA-seq data aligned to a reference genome, the reference genome in FASTA format, and cell barcode annotations embedded in BAM read tags. Cell barcodes are read from a configurable BAM tag (default: `CB` for 10x Genomics convention), and unique molecular identifiers (UMIs) read from a separate tag (default: `XM`). 

For cluster-guided mode, the workflow additionally requires cell cluster assignments as input, provided as a tab-separated file mapping cell barcodes to cluster identifiers. These assignments may be generated by the basic mode pipeline or provided from external clustering analyses. Reference gene annotations in GTF format are optional for discovery modes but required for quantification-only operation.

## Basic Mode Workflow

Initial Isoform Discovery: In basic mode, LRAA first performs transcript isoform discovery on the complete dataset by pooling all single-cell reads into a unified pseudobulk analysis. This initial discovery step constructs a splice graph from all cell barcodes combined, treating the dataset as conventional bulk RNA-seq to establish an initial catalog of expressed isoforms across the entire cell population. During this pooled quantification, read tracking information is recorded for each aligned read, capturing the cell barcode, read name, assigned isoform(s), splice structure, and assignment confidence. This tracking file serves as the foundation for downstream single-cell read count matrix construction.


Single-Cell Sparse Matrix Construction: For each unique cell barcode in the dataset, reads are aggregated at three hierarchical levels: (1) gene-level counts, summing all reads assigned to any isoform of a gene; (2) isoform-level counts, tallying reads assigned to specific transcript isoforms; and (3) splice pattern-level counts, grouping reads by unique splice junction combinations regardless of transcript identity. Splice patterns are encoded as hash codes derived from the ordered sequence of intron coordinates (as inspired by Isosceles), enabling detection of alternative splicing events independent of full-length isoform reconstruction.

Cell Quality Filtering: To distinguish genuine cells from empty droplets and low-quality cells, an optional filtering step applies the DropletUtils `emptyDrops` statistical framework (Lun et al., 2019). The gene-level sparse matrix is analyzed to model the ambient RNA profile from low-count barcodes and compute false discovery rates (FDR) for each barcode under the null hypothesis that observed counts arise solely from ambient contamination. Barcodes with FDR â‰¤ 0.01 (default) are retained as high-confidence cells. 

Cell Clustering: Cells are clustered using a Seurat-based workflow implemented in R that applies standard single-cell normalization, dimensionality reduction, and graph-based clustering to the filtered gene-level sparse matrix. The workflow follows conventional Seurat practices: (1) genes expressed in fewer than `min_cells` cells (default: 10) are filtered to remove rare features; (2) cells expressing fewer than `min_features` genes (default: 1000) or exceeding `percent_mt_max` mitochondrial content (default: 20%) are removed as low-quality; (3) raw counts are log-normalized to 10,000 reads per cell; (4) the top `n_variable_features` highly variable genes (default: 2000) are identified via variance-stabilizing transformation; (5) principal component analysis (PCA) is performed using the top variable genes, retaining `npcs` components (default: 12); (6) a shared nearest neighbor (SNN) graph is constructed in PCA space and clustered using the Louvain algorithm at resolution `resolution` (default: 0.6); and (7) Uniform Manifold Approximation and Projection (UMAP) is computed for visualization. Cell clustering results are exported as a tab-separated assignment file mapping each cell barcode to its cluster identifier, which serves as input for the downstream cluster-guided LRAA workflow.

## LRAA Cell Cluster-Guided Mode Workflow

BAM Partitioning by Cell Cluster: Following cell clustering (either from basic mode or provided precomputed assignments), the input BAM file is partitioned by cell cluster identity. Each read is examined for its cell barcode tag (default: `CB`) and matched against cluster assignments. Reads are written to cluster-specific BAM files (one per cluster), with unmapped reads and reads from barcodes not present in the cluster assignments excluded. This partitioning produces a set of pseudobulk BAM files, each containing all reads from cells belonging to a specific cluster. BAM files are coordinate-sorted and indexed, enabling efficient downstream processing. The partitioned BAM files are packaged into a compressed tarball for convenient retrieval and archival.

Per-Cluster Isoform Discovery: Each cluster-specific BAM is processed independently through the complete LRAA isoform discovery pipeline. When the initial discovery GTF is provided (derived from basic mode or provided as a reference), it serves as an initial annotation for reference-guided LRAA isoform identification as applied to each cluster-specific BAM.


Cell Cluster GTF Merging for a Consensus Isoform Catalog: Per-cluster GTF files are merged into a unified consensus annotation using a specialized execution of LRAA that treats the individual cluster-based isoform structures as collections of long RNA-seq reads, retaining annotated TSS and PolyA sites. The merging procedure effectively aggregates isoforms across cell clusters while resolving redundancy: isoforms with identical exon-intron structures (identical splice junctions and overlapping terminal exons) are collapsed into single consensus transcripts, with gene assignments unified across clusters. Novel isoforms discovered in only one cluster are mostly included in the final annotation if they pass expression and support thresholds, ensuring that well-supported cluster-specific variants are retained. The final merged GTF represents the comprehensive isoform catalog spanning all cell types, incorporating both shared isoforms expressed across clusters and cluster-specific transcript variants.

Final Quantification and Single-Cell Matrix Generation: After generating the consensus GTF, each cluster of cells is separately re-quantified against the merged isoform catalog and leveraging an identical splice graph to produce final abundance estimates. This ensures all cells are quantified using the same unified reference isoform catalog.The per-cluster read-to-isoform tracking files are merged into a single comprehensive tracking file spanning all cells and clusters, which serves as input for the final sparse matrix construction, yielding separate sparse feature-by-cell count matrices at gene-level, isoform-level, and splice pattern-level.

Reference Annotation Gene Symbol Integration: To facilitate interpretation and integration with reference annotations, an optional gene symbol incorporation step annotates LRAA-discovered isoforms with official gene symbols from a reference GTF. This procedure uses `gffcompare` to align the LRAA GTF against a reference annotation (eg. GENCODE), identifying matching or overlapping loci and transferring gene symbols to LRAA transcripts based on structural similarity. Matching criteria include exact matches, contained matches, and intron-chain-compatible matches, with priority given to transcripts exhibiting high structural concordance. After gene symbol assignment, all single-cell sparse matrices (gene, isoform, and splice pattern levels) are updated to similarly incorporate the gene symbols into the  LRAA-assigned feature identifiers (genes, isoforms, and splice patterns). 


## Computational Workflow Architecture and Optimization

 The workflow leverages parallel execution at multiple stages: initial discovery can be parallelized across genomic contigs when `main_chromosomes` is specified; per-cluster discovery in cluster-guided mode executes all clusters in parallel via WDL scatter blocks; and per-cluster quantification similarly parallelizes across cluster-specific BAMs. Resource allocation is configurable through workflow inputs, with separate memory and CPU parameters for discovery, quantification, clustering, and matrix-building tasks.

To support iterative analyses and avoid recomputation, the workflow accepts optional precomputed inputs: users can provide precomputed initial GTF and tracking files to skip initial discovery, or precomputed cluster assignments to skip cell filtering and clustering. This design enables expert users to provide curated cell cluster assignments to be leveraged in the downstream cluster-guided isoform identification and quantification workflow.

The workflow produces comprehensive outputs at each stage, including intermediate files for quality control and debugging: initial and final GTF files, per-cluster BAMs and tracking files, pseudobulk expression matrices, sparse single-cell matrices, Seurat objects, UMAP visualizations, and gene symbol mappings. 

All source code, WDL workflows, and documentation are publicly available at https://github.com/MethodsDev/LongReadAlignmentAssembler under the MIT License.


## References

Hao Y, Hao S, Andersen-Nissen E, Mauck WM, Zheng S, Butler A, Lee MJ, Wilk AJ, Darby C, Zager M, Hoffman P, Stoeckius M, Papalexi E, Mimitou EP, Jain J, Srivastava A, Stuart T, Fleming LM, Yeung B, Rogers AJ, McElrath JM, Blish CA, Gottardo R, Smibert P, Satija R. (2021). Integrated analysis of multimodal single-cell data. *Cell*, 184(13), 3573-3587.e29.

Lun ATL, Riesenfeld S, Andrews T, Dao TP, Gomes T, participants in the 1st Human Cell Atlas Jamboree, Marioni JC. (2019). EmptyDrops: distinguishing cells from empty droplets in droplet-based single-cell RNA sequencing data. *Genome Biology*, 20(1), 63.

Pertea G, Pertea M. (2020). GFF Utilities: GffRead and GffCompare. *F1000Research*, 9, 304.
